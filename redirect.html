<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loader {
            text-align: center;
            color: white;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h2 {
            margin: 0 0 10px 0;
        }
        p {
            margin: 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <h2>Redirecting to Amazon...</h2>
        <p>Please wait</p>
    </div>

    <script>
        // Configuration
        const AFFILIATE_TAGS = {
            'US': 'giftonbudge0f-20',
            'IN': 'giftonbudget-21'
        };

        const AMAZON_DOMAINS = {
            'US': 'amazon.com',
            'IN': 'amazon.in'
        };

        /**
         * Get country from URL parameter or detect via API
         */
        async function getUserCountry() {
            // Try to get from localStorage cache first
            const cached = localStorage.getItem('userCountryCode');
            const expiry = localStorage.getItem('userCountryCodeExpiry');

            if (cached && expiry && Date.now() < parseInt(expiry)) {
                return cached;
            }

            try {
                // Use ipapi.co for country detection
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();

                if (data && data.country_code) {
                    const country = data.country_code;
                    // Cache for 24 hours
                    localStorage.setItem('userCountryCode', country);
                    localStorage.setItem('userCountryCodeExpiry', (Date.now() + 86400000).toString());
                    return country;
                }
            } catch (error) {
                console.error('Geolocation failed:', error);
            }

            // Fallback: try timezone detection
            try {
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                if (timezone && (timezone.includes('Kolkata') || timezone.includes('Calcutta'))) {
                    return 'IN';
                }
            } catch (e) {
                console.error('Timezone detection failed:', e);
            }

            return 'US'; // Default
        }

        /**
         * Extract ASIN from Amazon URL
         */
        function extractASIN(url) {
            const patterns = [
                /\/dp\/([A-Z0-9]{10})/,
                /\/gp\/product\/([A-Z0-9]{10})/,
                /\/product\/([A-Z0-9]{10})/,
                /\/ASIN\/([A-Z0-9]{10})/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            return null;
        }

        /**
         * Build Amazon URL with correct domain and affiliate tag
         */
        function buildAmazonURL(asin, country) {
            const tag = AFFILIATE_TAGS[country] || AFFILIATE_TAGS['US'];
            const domain = AMAZON_DOMAINS[country] || AMAZON_DOMAINS['US'];
            return `https://www.${domain}/dp/${asin}?tag=${tag}`;
        }

        /**
         * Main redirect logic
         */
        async function performRedirect() {
            try {
                // Get URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const targetURL = urlParams.get('url');

                if (!targetURL) {
                    // No URL provided, go to homepage
                    window.location.href = '/index.html';
                    return;
                }

                // Get user's country
                const country = await getUserCountry();
                console.log('Detected country:', country);

                // For non-Indian users, redirect directly to original link
                if (country !== 'IN') {
                    window.location.href = decodeURIComponent(targetURL);
                    return;
                }

                // For Indian users, try to convert to Amazon.in
                // First, try to extract ASIN directly from the URL
                let asin = extractASIN(targetURL);

                if (asin) {
                    // Build Amazon.in URL
                    const redirectURL = buildAmazonURL(asin, 'IN');
                    console.log('Redirecting to:', redirectURL);
                    window.location.href = redirectURL;
                    return;
                }

                // If it's a shortened link, we need to expand it
                if (targetURL.includes('amzn.to')) {
                    // For shortened links, use a CORS proxy or just redirect
                    // Since we can't expand amzn.to client-side due to CORS,
                    // we'll use a different approach: add affiliate tag parameter

                    // Note: amzn.to shortened links can accept tag parameter
                    const separator = targetURL.includes('?') ? '&' : '?';
                    const redirectURL = `${targetURL}${separator}tag=${AFFILIATE_TAGS['IN']}`;

                    console.log('Redirecting to shortened link with tag:', redirectURL);
                    window.location.href = redirectURL;
                    return;
                }

                // Fallback: redirect to original URL
                window.location.href = decodeURIComponent(targetURL);

            } catch (error) {
                console.error('Redirect error:', error);
                // On error, try to redirect to original URL
                const urlParams = new URLSearchParams(window.location.search);
                const targetURL = urlParams.get('url');
                if (targetURL) {
                    window.location.href = decodeURIComponent(targetURL);
                } else {
                    window.location.href = '/index.html';
                }
            }
        }

        // Execute redirect when page loads
        performRedirect();
    </script>
</body>
</html>
